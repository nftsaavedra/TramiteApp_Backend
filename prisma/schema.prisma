// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


// -------------------
// Modelos de Autenticación y Usuarios
// -------------------

model User {
  id                 String       @id @default(cuid())
  email              String       @unique
  name               String
  password           String
  role               Role         @default(RECEPCIONISTA)
  isActive           Boolean      @default(true)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  oficina            Oficina?     @relation(fields: [oficinaId], references: [id])
  oficinaId          String?
  movimientosCreados Movimiento[]
  tramitesAsignados  Tramite[]    @relation("TramitesAsignados")
  anotacionesCreadas Anotacion[]
  @@map("users")
}

enum Role {
  RECEPCIONISTA
  ANALISTA
  ASESORIA
  ADMIN
}

// -------------------
// Modelos de Catálogo y Parametrización
// -------------------


enum TipoOficina {
  ORGANO_ALTA_DIRECCION
  ORGANO_DE_LINEA
  UNIDAD_ORGANICA
  ORGANO_DE_ASESORAMIENTO
  ORGANO_DE_APOYO
  EXTERNA
}

model Oficina {
  id                 String       @id @default(cuid())
  nombre             String       @unique
  siglas             String       @unique
  tipo               TipoOficina
  isActive           Boolean      @default(true)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  parentId           String?
  parent             Oficina?     @relation("JerarquiaOficinas", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children           Oficina[]    @relation("JerarquiaOficinas")
  usuarios           User[]
  
  // --- Relaciones de Trámites ---
  tramitesOriginados Tramite[]    @relation("Remitente")
  tramitesRecibidos  Tramite[]    @relation("DestinoPrincipal")
  tramitesEnCopia    Tramite[]    @relation("TramiteCopias")

  // --- Relaciones de Movimientos ---
  movimientosOrigen  Movimiento[] @relation("MovimientoOrigen")
  movimientosDestino Movimiento[] @relation("MovimientoDestino")

  esInquilino        Boolean      @default(false)

  @@map("oficinas")
}

model TipoDocumento {
  id          String       @id @default(cuid())
  nombre      String       @unique
  descripcion String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  tramites    Tramite[]
  movimientos Movimiento[]
  @@map("tipos_documento")
}

// -------------------
// Modelos del Core de Trámites
// -------------------
model Tramite {
  id                      String           @id @default(cuid())
  numeroDocumento         String
  nombreDocumentoCompleto String
  asunto                  String
  observaciones           String?
  estado                  EstadoTramite    @default(EN_PROCESO)
  prioridad               PrioridadTramite @default(NORMAL)
  fechaDocumento          DateTime
  fechaIngreso            DateTime         @default(now())
  fechaCierre             DateTime?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  
  tipoDocumentoId         String
  tipoDocumento           TipoDocumento    @relation(fields: [tipoDocumentoId], references: [id])
  
  // Remitente (Quien envía)
  oficinaRemitenteId      String
  oficinaRemitente        Oficina          @relation("Remitente", fields: [oficinaRemitenteId], references: [id])

  // Destinatario Principal (Para / Action Owner)
  oficinaDestinoId        String?
  oficinaDestino          Oficina?         @relation("DestinoPrincipal", fields: [oficinaDestinoId], references: [id])

  // Copias (CC / Informativo) - Solo registro, no genera movimientos automáticos
  copias                  Oficina[]        @relation("TramiteCopias")

  usuarioAsignadoId       String?
  usuarioAsignado         User?            @relation("TramitesAsignados", fields: [usuarioAsignadoId], references: [id])
  
  movimientos             Movimiento[]
  anotaciones             Anotacion[]

  @@map("tramites")
}

enum EstadoTramite {
  EN_PROCESO    
  FINALIZADO    
  ARCHIVADO     
}

enum PrioridadTramite {
  BAJA
  NORMAL
  ALTA
  URGENTE
}

model Movimiento {
  id                      String         @id @default(cuid())
  tipoAccion              TipoAccion
  
  numeroDocumento         String?
  nombreDocumentoCompleto String?
  asunto                  String?
  
  fechaDocumento          DateTime?
  notas                   String?
  observaciones           String?
  
  // Flag informativo (por si en el futuro decides registrar una copia manualmente)
  esCopia                 Boolean        @default(false)

  fechaCierre             DateTime?
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  
  tramiteId               String
  tramite                 Tramite        @relation(fields: [tramiteId], references: [id])
  
  usuarioCreadorId        String
  usuarioCreador          User           @relation(fields: [usuarioCreadorId], references: [id])
  
  // ORIGEN (De dónde sale)
  oficinaOrigenId         String
  oficinaOrigen           Oficina        @relation("MovimientoOrigen", fields: [oficinaOrigenId], references: [id])
  
  // DESTINO (A dónde llega)
  oficinaDestinoId        String?
  oficinaDestino          Oficina?       @relation("MovimientoDestino", fields: [oficinaDestinoId], references: [id])

  tipoDocumentoId         String?
  tipoDocumento           TipoDocumento? @relation(fields: [tipoDocumentoId], references: [id])
  
  anotaciones             Anotacion[]

  @@map("movimientos")
}

enum TipoAccion {
  DERIVACION
  RESPUESTA
  ASIGNACION
  ARCHIVO
  CIERRE
}

model Anotacion {
  id        String   @id @default(cuid())
  contenido String
  createdAt DateTime @default(now())
  tramite   Tramite  @relation(fields: [tramiteId], references: [id])
  tramiteId String
  autor     User     @relation(fields: [autorId], references: [id])
  autorId   String
  @@map("anotaciones")
}


// -------------------
// Modelos de Soporte (Trazabilidad)
// -------------------

model Feriado {
  id          String   @id @default(cuid())
  fecha       DateTime @unique @db.Date
  descripcion String
  @@map("feriados")
}